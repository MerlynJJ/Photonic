use strict;
use warnings;
use PDL;
use PDL::Complex;
use Photonic::Utils;
Photonic::Utils->import(@Photonic::Utils::EXPORT_OK);
use Test::More;

# not yet covered: GtoR, RtoG, vectors2Dlist

my $x = zeroes(2, 11)->complex;
$x->slice(':,0') .= 1+0*i;
ok approx(HProd($x, $x), r2C(1));
ok approx(EProd($x, $x), r2C(1));

$x = zeroes(2, 1, 11)->complex;
$x->slice(':,:,0') .= 1+0*i;
ok approx(MHProd($x, $x, ones(1, 1, 11)), r2C(1));

$x = zeroes(2, 2, 11)->complex;
$x->slice(':,:,0') .= 1/sqrt(2)+0*i;
ok approx(SProd($x, $x), r2C(1));

$x = zeroes(2, 1, 2, 11)->complex;
$x->slice(':,:,:,0') .= 1/sqrt(2)+0*i;
ok approx(VSProd($x, $x), r2C(1));

my $got = lentzCF(
  pdl([21/11 + 32*i/11, 23/11 + 34*i/11])->cplx,
  pdl([r2C(-1), -8.7603535536828499e-17 - 1.98347107438017*i])->cplx,
  2,
  1e-7,
);
my $expected = 1.4688427299703299 + 2.6112759643916901*i;
ok approx($got, $expected) or diag "got: $got, expected $expected";

$expected = -1.2045454545454499 - 0.79545454545454497*i;
$got = lentzCF(
  $expected,
  -1 - 0.247933884297521*i,
  1,
  1e-7,
);
ok approx($got, $expected) or diag "got: $got, expected $expected";

$expected = pdl <<'EOF';
[
 [
  [
   [     1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115      1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115      1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115]
   [   -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402    -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402    -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402]
   [  1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16   1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16   1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16]
   [    0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402     0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402     0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402]
   [    -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115     -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115     -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115]
   [     1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115      1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115      1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115]
   [   -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402    -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402    -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402]
   [  1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16   1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16   1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16]
   [    0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402     0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402     0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402]
   [    -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115     -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115     -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115]
   [     1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115      1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115      1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115]
   [   -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402    -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402    -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402]
   [  1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16   1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16   1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16]
   [    0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402     0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402     0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402]
   [    -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115     -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115     -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115]
  ]
  [
   [  0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639   0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639   0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639]
   [  -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357   -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357   -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357]
   [ 6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17  6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17  6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17]
   [   0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357    0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357    0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357]
   [ -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639  -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639  -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639]
   [  0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639   0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639   0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639]
   [  -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357   -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357   -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357]
   [ 6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17  6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17  6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17]
   [   0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357    0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357    0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357]
   [ -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639  -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639  -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639]
   [  0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639   0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639   0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639]
   [  -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357   -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357   -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357]
   [ 6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17  6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17  6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17]
   [   0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357    0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357    0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357]
   [ -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639  -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639  -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639]
  ]
 ]
 [
  [
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [ -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781  -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781  -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [ -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781  -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781  -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [ -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781  -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781  -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453   1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937   2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
  ]
  [
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999  -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999  -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999  -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999  -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999  -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999  -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552  0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445  0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
  ]
 ]
]
EOF
$got = tile(pdl(<<'EOF'), 3, 3);
[
 [
  [
   [     1.3495115   -0.023957563 -5.9880532e-16    0.023957563     -1.3495115]
   [   -0.10812402    -0.85100218  1.4240728e-17     0.85100218     0.10812402]
   [  1.110223e-16  4.9960036e-16 -2.9610637e-16  2.7755576e-16 -5.5511151e-16]
   [    0.10812402     0.85100218  1.5850844e-16    -0.85100218    -0.10812402]
   [    -1.3495115    0.023957563 -1.2080698e-16   -0.023957563      1.3495115]
  ]
  [
   [  0.0081485639   0.0081573366  1.1177956e-17  -0.0081573366  -0.0081485639]
   [  -0.009254357   0.0041060736  5.5476509e-18  -0.0041060736    0.009254357]
   [ 6.9388939e-18  1.2750218e-16  1.2143128e-17  -1.405126e-16  2.2551405e-17]
   [   0.009254357  -0.0041060736 -4.1711898e-18   0.0041060736   -0.009254357]
   [ -0.0081485639  -0.0081573366  -2.084947e-17   0.0081573366   0.0081485639]
  ]
 ]
 [
  [
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [ -3.7800781  -1.4194227 -0.64872161  -1.4194227  -3.7800781]
   [  1.5120453 -0.55214223 -0.25087687 -0.55214223   1.5120453]
   [  2.8779937   3.7618536   3.0752377   3.7618536   2.8779937]
  ]
  [
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ -0.031969999 -0.0079121337  -0.015230545 -0.0079121337  -0.031969999]
   [ 0.0067999552  -0.013824409  -0.016607758  -0.013824409  0.0067999552]
   [ 0.0091850445   0.017780476   0.024223031   0.017780476  0.0091850445]
  ]
 ]
]
EOF
ok all(approx($got, $expected)) or diag "got: $got, expected $expected";

done_testing;
